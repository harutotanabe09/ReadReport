＃読書レポート

## 失敗から学ぶRDBの正しいあるき方

### ＊　読んだきっかけ

・DBの設計について書かれている本がすくない。どういったテーブル構成に悩んで行き着いた。

　今の社内システムのDBが特にひどいので、テーブルを再定義するのに役に立つ。

### ＊　本の内容

・アンチパターンの設計をしないためにどういった対応が必要か、またアンチパターンでの実装済みのテーブルをどう修正するか、現場のあるある事例を元に具体的な対応が書かれている

### ＊　学び

・パタンー１）項目名と実際に入っている項目が合わない。

　例）　削除フラグに０，１以外にも２や３といった値が入っている。

　→　対策①型をBooleanにする②新しい項目を作成してトリガーで値をセット、問題なければ元の項目削除

・パターン２）履歴テーブルを持たないと過去の状態がわからない

　例）　消費税が8%という値をもっていたため、10％上げるとすべて10％になった

　→　対策①期間という軸をもたせる。ただし、過去（履歴テーブル）を残すとデータが肥大化する。

　　　対策②遅延したレプリケーションをもたせる

・パターン３）むやみにJOINしているテーブル

　例）　５つや６つのテーブルをJOINしている。JOINの内部表にINDEXがないためパフォーマンスも遅い

　→　対策①　JOINする前にサブクエリで絞り込んでJOINする

・パターン４）効かないIndex

　例）名前を後方一致で検索など

　→　対策①　20％未満に絞れる項目が1つの目安

　　　対策②　テーブルのデータが多いのが条件。マスタ系だとデータ量すくないのでつけても無駄なケースも。

　　　対策③　関数を使わない　 age / 10 < 10 など式を使うと遅い

・パターン５）フラグの闇

　例）削除フラグを持つことで、１つのIDで削除フラグ１と０ができてしまう

　→　対策①　項目ではなくテーブルでデータを持つ[削除済みテーブル]にデータを移す。トリガー使う。

・パターン６）ソートの依存

　例）ORDER BYを使っているが、過去ページになると表示が遅い

　→　対策①　ORDER BYにINDEX項目を使う？？★要調査。

　　　対策②　ID項目を使う

　　　対策③　キャッシュ（Redis)を使う。Sorted Setは早い。ただ、永続データが苦手。

・パターン７）隠された状態

　例）社員番号が９の番号を管理者と★アプリ★側で制御している

　→　対策①　事実のみをDBに登録する。テーブルのサブテーブルに権限を追加して状態をもたせる

・パターン８）JSONの甘い罠

　例）項目にJSON型をつかっている